# CVE-2018-1724: IBM Spectrum LSF Local Privilege Escalation

## Overview

IBM Spectrum LSF is a set of tools designed to provide scheduling and resource management for HPC/Cluster workloads. These tools help make the cluster more efficient by fairly scheduling various user workloads, allowing users to define custom jobs, keeping track of time spent for cost recovery purposes, and orchestrating steps of a compute job across multiple compute nodes. HPC systems are typically used by multiple teams (some of which may be in competition with each other) so both horizontal and vertical privilege escalation vulnerabilities are somewhat more serious than on single-user systems. In addition, user software generally needs to be compiled specifically against local libraries in order to be optimized for HPC computational hardware and high-speed interconnect bridging the compute nodes. Bring-your-own-software is standard practice in scientific computing, so very tight policing of the userspace by the OS kernel is paramount to HPC security. Furthermore, because HPC resources are by definition clustered systems, escalation of privileges of any component often times directly translates to escalation on many components of the distributed HPC system. This vulnerability exposes a flaw in `eauth` -- one tool that LSF uses to authenticate users between multiple parts of the HPC cluster. This writeup will demonstrate how `bsub`, the job submission command, can use `eauth` to submit jobs with the context of another user (including root!).

## Links

https://www.ibm.com/products/hpc-workload-management
https://www.ibm.com/support/pages/node/734767
http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1724

## Tools

  * Linux Command Line Tools
  * `strace`
  * LD_PRELOAD
  * Linux System Calls
  * Cryptography
  * Entropy
  * C / gcc
  * HPC Job Submission

## Writeup

`eauth` is a system utility provided by LSF which outputs a secret token to standard out.  The output of the `eauth` command changes regularly when run consistently on the command line. The token is submitted to a job scheduler along with the compute job specification when users run `bsub`.

Example bsub output.

Example eauth output.

### Discovery

The first thing that jumps out is how simple the output of `eauth` seems to be (at least in 2018 when this work was performed!).  Increasing entropy is a sure-fire way to increase the difficulty of guessing secrets; bit-lengths of 256-512 bits (32-64 characters) are considered strong. Web-based api keys are typically this complex and much longer than `eauth` output, so brute-forcing `eauth` secrets was initially discussed as a plan of attack.

Since `eauth` is used to provide authenticity to job submission requests, it seemed reasonable to try to characterize the way it is invoked by typical users running scientific workloads.

### Investigating Typical Job Submission

One of the super awesome tools that should be in the toolbox of every linux-hacker is `strace`.  `strace` lets you attach to a process that you own and capture all of the system calls that your process makes into the kernel.  This is incredibly useful during the initial 'just-trying-to-grok-this' stage of exploitation because you can see all of the various files that your process accesses, the child processes that are created, network communication that is set up, etc.  In this case, we use `strace` to see how our job submission process interacts with `eauth`.  In this instance, we are running a simple job to request a single compute node worth of compute power and launch an interactive shell -- `/bin/bash`.  The other options aren't too important for this writeup, but they mainly deal with scheduling and accounting/allocation intricacies.

** Insert diagram

After capturing `strace` output, it's immediately apparent that `bsub` is using the system-installed `eauth` during execution (presumably to grab an auth token to pass alongside the interactive `/bin/bash` job request to the job scheduler).  The question is: can we somehow crowbar our way into exploting `eauth` weaknesses?

### The First Roadblock: Can we even obtain a token of other users?

One of the things that


### Second Roadblock: Forging a Job submission

### Third Roadblock:

## Acknowledgements
