# CVE-2018-1776: IBM Spectrum LSF Local Privilege Escalation

## Overview

Older versions of the Burst Buffer proxy daemon are susceptible to command injection under certain error conditions.  Burst Buffer is a type of buffer/cache that is available for the pre-staging (and post-staging) of data before and after a scientific job is placed on a compute node. Because simulations at scale are extremely fine-grained, scientific compute jobs will often wait for some time at the beginning of their code execution for data to stream into memory from fast scratch.  Burst Buffering is directed by system-level processes to pre-stage the next job's data onto compute node-local NVMe drives and reduce idle time spent on I/O at the beginning and end of compute jobs. Because this capability can be directed by system-level processes and the scheduler, it is of particular interest from an authentication and trust boundary perspective.

## Links
  - https://github.com/IBM/CAST
  - https://www-01.ibm.com/support/docview.wss?uid=ibm10733555

## Tools and Background Knowledge

  * Linux Command Line Tools
  * C / gcc
  * FUSE user space filesystem daemon
  * Command injection

## Writeup

The Burst Buffer proxy daemon runs on compute nodes and services burst buffer requests to stage data prior to and after a compute job has finished. Unfortunately, there are certain error conditions that result in the execution of un-escaped user input. When an EBUSY error is thrown, `bbproxy` debugs the current state of the system by running `lsof` on the file that was attempted to be accessed.  We can utilize this to inject arbitrary commands (that will run as the privileged root user) and gain total control of the system.

### Diagram
```
                    ┌─────────────────┐   ┌─────────────────────────────────────────┐
                    │   Login Node    │   │              Compute Node               │
                    │                 │   │                                         │
┌─────────────┐     │                 │   │                                         │
│   User @    │   ┌─┴─────┐  ┌──────┐ │ ┌─┴─────┐  ┌──────┐         ┌─────────────┐ │
│ Institution ├───▶ sshd  ├──▶ bash ├─┼─▶ sshd  ├──▶ bash ├─────────▶   bbproxy   │ │
└─────────────┘   └─┬─────┘  └──────┘ │ └─┬─────┘  └──────┘         └─────────────┘ │
                    └─────────────────┘   └─────────────────────────────────────────┘
```



### Putting it all together

By creating specially crafted directories, (including semicolons!), we can force additional commands besides rmdir to be executed by the burst buffer proxy as a privileged user.  This results in a full system compromise.

![Recorded exploitation of this burst buffer proxy shell injection vulnerability](https://github.com/rmadamson/rmadamson/blob/main/writeups/gifs/bbshell.gif)


### The fix

IBM's CAST 1.2.0 release fixes this particular vulnerability.

## Acknowledgements

This research used resources of the Oak Ridge Leadership Computing Facility at the Oak Ridge National Laboratory, which is supported by the Office of Science of the U.S. Department of Energy under Contract No. DE-AC05-00OR22725.
