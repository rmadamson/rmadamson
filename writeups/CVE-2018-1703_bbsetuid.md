# CVE-2018-1703: Burst Buffer Setuid Root Escalation

## Overview

Burst Buffer is a type of buffer/cache that is available for the pre-staging (and post-staging) of data before and after a scientific job is placed on a compute node. Because simulations at scale are extremely fine-grained, scientific compute jobs will often wait for some time at the beginning of their code execution for data to stream into memory from fast scratch.  Burst Buffering is directed by system-level processes to pre-stage the next job's data onto compute node-local NVMe drives and reduce idle time spent on I/O at the beginning and end of compute jobs. Because this capability can be directed by system-level processes and the scheduler, it is of particular interest from an authentication and trust boundary perspective.

## Links

  - https://github.com/IBM/CAST
  - https://www-01.ibm.com/support/docview.wss?uid=ibm10734239
  - http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1703

## Tools and Background Knowledge

  * Linux Command Line Tools
  * find
  * PERL

## Writeup

The Burst Buffer package ships several tools for related to the Burst Buffer ecosystem. Some of these were used early on in Burst Buffer development to emulate the Burst Buffer `bbproxy` before it was complete so that client side command line tooling could be developed.  These tools were installed by RPMs with the setuid bit set, meaning that users on the system can run these administrative tools and take advantage of any arbitrary code execution flaws within.

### Diagram

```
                    ┌─────────────────┐   ┌─────────────────────────────────────────────────────────────────┐
                    │   Login Node    │   │                          Compute Node                           │
                    │                 │   │                                     ┌─────────────┐   ┌────────┐│
┌─────────────┐     │                 │   │                  ┌─────────────┐    │ bbtools.pm  │   │  User  ││
│   User @    │   ┌─┴─────┐  ┌──────┐ │ ┌─┴─────┐  ┌──────┐  │stagein_admin│  ┌─┴─────────────┴─┐ │Defined ││
│ Institution ├───▶ sshd  ├──▶ bash ├─┼─▶ sshd  ├──▶ bash ├──▶ (rwsr-xr-x) ├──▶stagein_admin.pl ├─▶  Code  ││
└─────────────┘   └─┬─────┘  └──────┘ │ └─┬─────┘  └──────┘  └─────────────┘  └─────────────────┘ └────────┘│
                    └─────────────────┘   └─────────────────────────────────────────────────────────────────┘
```

### Putting it all together

By configuring our environment just right, we can provide arbitrary code to the `stagein_admin` command and gain privileges.

![Recorded exploitation of this Burst Buffer vulnerability](https://github.com/rmadamson/rmadamson/blob/main/writeups/gifs/setuid.gif)


### The fix

The fix for this is to not package setuid binaries when they aren't strictly necessary.  Information about affected versions can be found by following the links at the beginning of this writeup.

## Acknowledgements

This research used resources of the Oak Ridge Leadership Computing Facility at the Oak Ridge National Laboratory, which is supported by the Office of Science of the U.S. Department of Energy under Contract No. DE-AC05-00OR22725.
